<div class="container">
  <a class="back" routerLink="/">
    <span>‚Üê</span> Back
  </a>

  <!-- Loading state -->
  <div *ngIf="loadingCondition" class="loading-skeleton">
    <div class="skeleton skeleton-title"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text" [style.width]="'80%'"></div>
    <div style="margin-top: 24px;">
      <div class="skeleton skeleton-text"></div>
      <div class="skeleton skeleton-text"></div>
      <div class="skeleton skeleton-text" [style.width]="'70%'"></div>
    </div>
  </div>

  <div *ngIf="error" class="error">
    {{ error }}
  </div>

  <ng-container *ngIf="data && !loadingCondition">
    <h2>{{ data.name }}</h2>
    <p class="muted">{{ data.description }}</p>

    <div class="tabs">
      <button 
        type="button" 
        [class.active]="tab==='overview'" 
        (click)="setTab('overview')"
      >
        Overview
      </button>
      <button 
        type="button" 
        [class.active]="tab==='body'" 
        (click)="setTab('body')"
      >
        Body Systems
      </button>
      <button 
        type="button" 
        [class.active]="tab==='visualizations'" 
        (click)="setTab('visualizations')"
      >
        üìä Data & Maps
      </button>
    </div>

    <!-- OVERVIEW TAB -->
    <section *ngIf="tab==='overview'">
      <h3>Overview</h3>

      <!-- Stats Cards -->
      <app-condition-stats *ngIf="data" [data]="data"></app-condition-stats>

      <div class="overview-box">
        <p class="pre" *ngIf="data.sections.overview">{{ data.sections.overview }}</p>
        <p class="muted" *ngIf="!data.sections.overview">No overview available yet.</p>
      </div>

      <h3>Symptoms</h3>
      <div *ngIf="data.sections.symptoms?.length">
        <ul class="list">
          <li *ngFor="let s of data.sections.symptoms">
            <span class="badge">{{ s }}</span>
          </li>
        </ul>
      </div>
      <p class="muted" *ngIf="!data.sections.symptoms?.length">No symptoms found.</p>

      <h3>Risk Factors</h3>
      <div *ngIf="data.sections.riskFactors?.length">
        <ul class="list">
          <li *ngFor="let r of data.sections.riskFactors">
            <span class="badge badge-warning">{{ r }}</span>
          </li>
        </ul>
      </div>
      <p class="muted" *ngIf="!data.sections.riskFactors?.length">No risk factors found.</p>

      <h3>Prevention</h3>
      <div *ngIf="data.sections.prevention?.length">
        <ul class="list">
          <li *ngFor="let p of data.sections.prevention">{{ p }}</li>
        </ul>
      </div>
      <p class="muted" *ngIf="!data.sections.prevention?.length">No prevention info found.</p>

      <h3>Sources</h3>
      <ul class="list">
        <li *ngFor="let src of data.sources">
          <a *ngIf="src.url" [href]="src.url" target="_blank" rel="noreferrer" class="source-link">
            {{ src.name }} <span style="font-size: 12px;">‚Üó</span>
          </a>
          <span *ngIf="!src.url">{{ src.name }}</span>
        </li>
      </ul>

      <p class="muted small" style="margin-top: 32px; padding: 16px; background: rgba(37, 99, 235, 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">
        ‚ìò Educational only ‚Äî not medical advice. Always consult qualified healthcare professionals.
      </p>

      <!-- Learning Quiz -->
      <app-learning-quiz [conditionName]="data?.name || ''"></app-learning-quiz>
    </section>

    <!-- BODY SYSTEMS TAB -->
    <section *ngIf="tab==='body'">
      <h3>Affected Body Systems</h3>
      
      <!-- Body Visualization Component -->
      <app-body-visualization 
        *ngIf="data && data.bodySystems" 
        [affectedSystems]="affectedSystems"
      ></app-body-visualization>

      <div *ngIf="data.bodySystems?.length" style="margin-top: 24px;">
        <h4>Details</h4>
        <ul class="list">
          <li *ngFor="let b of data.bodySystems">
            <span class="badge badge-info">{{ b.label }}</span>
          </li>
        </ul>
      </div>
      <p class="muted" *ngIf="!data.bodySystems?.length">No specific body systems data available.</p>
    </section>

    <!-- VISUALIZATIONS TAB -->
    <section *ngIf="tab==='visualizations'">
      <h3>üìä Data Visualizations & Maps</h3>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
        <label style="font-weight:600;margin-right:8px;">Country</label>
        <select [(ngModel)]="country" (change)="refreshGeo()">
          <option *ngFor="let c of countries" [value]="c">{{ c }}</option>
        </select>
        <button type="button" (click)="refreshGeo()" style="margin-left:8px;">Refresh Geo</button>
        <div *ngIf="loadingGeo" style="margin-left:12px;color:var(--text-muted);">Loading geo...</div>
        <div *ngIf="geoError" style="margin-left:12px;color:#b91c1c;">{{ geoError }}</div>
      </div>

      <!-- Data Visualization Charts -->
      <app-data-visualization
        *ngIf="data"
        [symptoms]="(data.sections.symptomsScores?.length ? data.sections.symptomsScores : (data.sections.symptoms || [])) || []"
        [riskFactors]="(data.sections.riskFactorsScores?.length ? data.sections.riskFactorsScores : (data.sections.riskFactors || [])) || []"
        [indicators]="data.indicators || []"
      ></app-data-visualization>

      <!-- Geo Heatmap Component -->
      <h4 style="margin-top: 32px;">Geographic Distribution</h4>
      <app-geo-heatmap 
        *ngIf="data" 
        [conditionName]="data?.name || ''"
        [country]="country"
        [geo]="geo"
      ></app-geo-heatmap>

      <p class="muted small" style="margin-top: 32px; padding: 16px; background: rgba(37, 99, 235, 0.05); border-radius: 8px; border-left: 4px solid var(--accent);">
        ‚ìò These visualizations are educational representations. Actual disease prevalence varies based on multiple factors including healthcare infrastructure, climate, population density, and genetic factors.
      </p>
    </section>
  </ng-container>
</div>
